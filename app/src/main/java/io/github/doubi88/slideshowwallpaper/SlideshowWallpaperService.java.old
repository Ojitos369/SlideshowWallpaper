/*package io.github.doubi88.slideshowwallpaper;

 * Slideshow Wallpaper: An Android live wallpaper displaying custom images and videos.

 * Copyright (C) 2022  Doubi88 <tobis_mail@yahoo.de>import android.app.WallpaperColors;

 *import android.content.SharedPreferences;

 * Slideshow Wallpaper is free software: you can redistribute it and/or modifyimport android.graphics.Bitmap;

 * it under the terms of the GNU General Public License as published byimport android.graphics.Canvas;

 * the Free Software Foundation, either version 3 of the License, orimport android.graphics.Color;

 * (at your option) any later version.import android.graphics.Paint;

 *import android.net.Uri;

 * Slideshow Wallpaper is distributed in the hope that it will be useful,import android.os.Build;

 * but WITHOUT ANY WARRANTY; without even the implied warranty ofimport android.os.Handler;

 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See theimport android.os.Looper;

 * GNU General Public License for more details.import android.service.wallpaper.WallpaperService;

 *import android.util.Log;

 * You should have received a copy of the GNU General Public Licenseimport android.view.GestureDetector;

 * along with this program.  If not, see <https://www.gnu.org/licenses/>.import android.view.MotionEvent;

 *import android.view.SurfaceHolder;

 */import android.app.WallpaperManager;

package io.github.doubi88.slideshowwallpaper;

import androidx.annotation.RequiresApi;

import android.app.WallpaperColors;

import android.content.SharedPreferences;import io.github.doubi88.slideshowwallpaper.preferences.SharedPreferencesManager;

import android.graphics.Bitmap;import io.github.doubi88.slideshowwallpaper.utilities.CurrentMediaHandler;

import android.graphics.Canvas;import io.github.doubi88.slideshowwallpaper.utilities.MediaInfo;

import android.graphics.Color;

import android.graphics.Paint;public class SlideshowWallpaperService extends WallpaperService {

import android.net.Uri;    private static final String TAG = "SlideshowWallpaperService";

import android.os.Build;

import android.os.Handler;    @Override

import android.os.Looper;    public Engine onCreateEngine() {

import android.service.wallpaper.WallpaperService;        return new SlideshowWallpaperEngine();

import android.util.Log;    }

import android.view.GestureDetector;

import android.view.MotionEvent;    public class SlideshowWallpaperEngine extends Engine {

import android.view.SurfaceHolder;        private Handler handler;

import android.app.WallpaperManager;        private CurrentMediaHandler currentMediaHandler;

        private int width;

import androidx.annotation.RequiresApi;        private int height;

        private Paint imagePaint;

import io.github.doubi88.slideshowwallpaper.preferences.SharedPreferencesManager;        private float deltaX;

import io.github.doubi88.slideshowwallpaper.utilities.CurrentMediaHandler;        private boolean isScrolling = false;

import io.github.doubi88.slideshowwallpaper.utilities.MediaInfo;        private SharedPreferencesManager manager;

        private GestureDetector gestureDetector;

public class SlideshowWallpaperService extends WallpaperService {        private boolean surfaceReady = false;

    private static final String TAG = "SlideshowWallpaperService";

        public SlideshowWallpaperEngine() {

    @Override            SharedPreferences prefs = getSharedPreferences();

    public Engine onCreateEngine() {            manager = new SharedPreferencesManager(prefs);

        return new SlideshowWallpaperEngine();            handler = new Handler(Looper.getMainLooper());

    }            imagePaint = new Paint();

            if (manager.getAntiAlias()) {

    public class SlideshowWallpaperEngine extends Engine {                imagePaint.setAntiAlias(true);

        private Handler handler;            }

        private CurrentMediaHandler currentMediaHandler;            initializeGestureDetector();

        private int width;        }

        private int height;

        private Paint imagePaint;        private void initializeGestureDetector() {

        private float deltaX;            gestureDetector = new GestureDetector(getApplicationContext(), new GestureDetector.SimpleOnGestureListener() {

        private boolean isScrolling = false;                private static final int SWIPE_THRESHOLD_VELOCITY = 200;

        private SharedPreferencesManager manager;

        private GestureDetector gestureDetector;                @Override

        private boolean surfaceReady = false;                public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {

                    if (manager.getSwipeToChange()) {

        public SlideshowWallpaperEngine() {                        if (e1.getX() - e2.getX() > 50 && Math.abs(velocityX) > SWIPE_THRESHOLD_VELOCITY) {

            SharedPreferences prefs = getSharedPreferences();                            currentMediaHandler.forceNextMedia(getApplicationContext());

            manager = new SharedPreferencesManager(prefs);                            return true;

            handler = new Handler(Looper.getMainLooper());                        } else if (e2.getX() - e1.getX() > 50 && Math.abs(velocityX) > SWIPE_THRESHOLD_VELOCITY) {

            imagePaint = new Paint();                            currentMediaHandler.forcePreviousMedia(getApplicationContext());

            if (manager.getAntiAlias()) {                            return true;

                imagePaint.setAntiAlias(true);                        }

            }                    }

            initializeGestureDetector();                    return super.onFling(e1, e2, velocityX, velocityY);

        }                }



        private void initializeGestureDetector() {                @Override

            gestureDetector = new GestureDetector(getApplicationContext(), new GestureDetector.SimpleOnGestureListener() {                public boolean onDoubleTap(MotionEvent e) {

                private static final int SWIPE_THRESHOLD_VELOCITY = 200;                    if (currentMediaHandler.getCurrentMedia() != null && 

                        currentMediaHandler.getCurrentMedia().isVideo()) {

                @Override                        if (currentMediaHandler.isPaused()) {

                public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {                            currentMediaHandler.resume(getApplicationContext());

                    if (manager.getSwipeToChange()) {                        } else {

                        if (e1.getX() - e2.getX() > 50 && Math.abs(velocityX) > SWIPE_THRESHOLD_VELOCITY) {                            currentMediaHandler.pause();

                            currentMediaHandler.forceNextMedia(getApplicationContext());                        }

                            return true;                        return true;

                        } else if (e2.getX() - e1.getX() > 50 && Math.abs(velocityX) > SWIPE_THRESHOLD_VELOCITY) {                    }

                            currentMediaHandler.forcePreviousMedia(getApplicationContext());                    return super.onDoubleTap(e);

                            return true;                }

                        }            });

                    }        }

                    return super.onFling(e1, e2, velocityX, velocityY);

                }        @Override

        public void onTouchEvent(MotionEvent event) {

                @Override            super.onTouchEvent(event);

                public boolean onDoubleTap(MotionEvent e) {            if (manager.getSwipeToChange() || (currentMediaHandler != null && 

                    if (currentMediaHandler.getCurrentMedia() != null &&                 currentMediaHandler.getCurrentMedia() != null && 

                        currentMediaHandler.getCurrentMedia().isVideo()) {                currentMediaHandler.getCurrentMedia().isVideo())) {

                        if (currentMediaHandler.isPaused()) {                gestureDetector.onTouchEvent(event);

                            currentMediaHandler.resume(getApplicationContext());            }

                        } else {        }

                            currentMediaHandler.pause();

                        }        @Override

                        return true;        public void onSurfaceCreated(SurfaceHolder holder) {

                    }            super.onSurfaceCreated(holder);

                    return super.onDoubleTap(e);            this.surfaceReady = true;

                }        }

            });

        }        @Override

        public void onSurfaceChanged(SurfaceHolder holder, int format, int width, int height) {

        @Override            super.onSurfaceChanged(holder, format, width, height);

        public void onTouchEvent(MotionEvent event) {            this.width = width;

            super.onTouchEvent(event);            this.height = height;

            if (manager.getSwipeToChange() || (currentMediaHandler != null && 

                currentMediaHandler.getCurrentMedia() != null &&             if (currentMediaHandler == null) {

                currentMediaHandler.getCurrentMedia().isVideo())) {                currentMediaHandler = new CurrentMediaHandler(manager, width, height);

                gestureDetector.onTouchEvent(event);                currentMediaHandler.addNextMediaListener(this::displayCurrentMedia);

            }                currentMediaHandler.updateAfter(getApplicationContext(), 0);

        }            } else {

                currentMediaHandler.setDimensions(width, height, getApplicationContext());

        @Override                displayCurrentMedia(currentMediaHandler.getCurrentMedia());

        public void onSurfaceCreated(SurfaceHolder holder) {            }

            super.onSurfaceCreated(holder);        }

            this.surfaceReady = true;

        }        @Override

        public void onSurfaceDestroyed(SurfaceHolder holder) {

        @Override            super.onSurfaceDestroyed(holder);

        public void onSurfaceChanged(SurfaceHolder holder, int format, int width, int height) {            this.surfaceReady = false;

            super.onSurfaceChanged(holder, format, width, height);            if (currentMediaHandler != null) {

            this.width = width;                currentMediaHandler.stop();

            this.height = height;            }

        }

            if (currentMediaHandler == null) {

                currentMediaHandler = new CurrentMediaHandler(manager, width, height);        @Override

                currentMediaHandler.addNextMediaListener(this::displayCurrentMedia);        public void onVisibilityChanged(boolean visible) {

                currentMediaHandler.updateAfter(getApplicationContext(), 0);            super.onVisibilityChanged(visible);

            } else {            if (currentMediaHandler != null) {

                currentMediaHandler.setDimensions(width, height, getApplicationContext());                if (visible) {

                displayCurrentMedia(currentMediaHandler.getCurrentMedia());                    currentMediaHandler.resume(getApplicationContext());

            }                } else {

        }                    currentMediaHandler.pause();

                }

        @Override            }

        public void onSurfaceDestroyed(SurfaceHolder holder) {        }

            super.onSurfaceDestroyed(holder);

            this.surfaceReady = false;        private void displayCurrentMedia(MediaInfo media) {

            if (currentMediaHandler != null) {            handler.post(() -> {

                currentMediaHandler.stop();                if (!surfaceReady) return;

            }

        }                if (media != null && media.getUri() != null) {

                    if (media.isVideo()) {

        @Override                        // For videos, just display the thumbnail

        public void onVisibilityChanged(boolean visible) {                        drawImage(media);

            super.onVisibilityChanged(visible);                    } else {

            if (currentMediaHandler != null) {                        drawImage(media);

                if (visible) {                    }

                    currentMediaHandler.resume(getApplicationContext());                } else {

                } else {                    drawBlackScreen();

                    currentMediaHandler.pause();                }

                }            });

            }        }

        }

        private void drawImage(MediaInfo media) {

        private void displayCurrentMedia(MediaInfo media) {            if (media == null || media.getImage() == null) {

            handler.post(() -> {                drawBlackScreen();

                if (!surfaceReady) return;                return;

            }

                if (media != null && media.getUri() != null) {

                    // Always draw the image/thumbnail            SurfaceHolder holder = getSurfaceHolder();

                    drawImage(media);            Canvas canvas = null;

                } else {            try {

                    drawBlackScreen();                canvas = holder.lockCanvas();

                }                if (canvas != null) {

            });                    Bitmap bitmap = media.getImage();

        }                    SharedPreferencesManager.TooWideImagesRule rule = manager.getTooWideImagesRule(getResources());

                    boolean antiAlias = manager.getAntiAlias();

        private void drawImage(MediaInfo media) {                    boolean antiAliasScrolling = manager.getAntiAliasWhileScrolling();

            if (media == null || media.getImage() == null) {                    imagePaint.setAntiAlias(antiAlias && (!isScrolling || antiAliasScrolling));

                drawBlackScreen();

                return;                    float scaleX = (float) width / bitmap.getWidth();

            }                    float scaleY = (float) height / bitmap.getHeight();

                    float scale = 1f;

            SurfaceHolder holder = getSurfaceHolder();                    int left = 0;

            Canvas canvas = null;                    int top = 0;

            try {

                canvas = holder.lockCanvas();                    switch(rule) {

                if (canvas != null) {                        case FIT_WIDTH:

                    Bitmap bitmap = media.getImage();                            scale = scaleX;

                    SharedPreferencesManager.TooWideImagesRule rule = manager.getTooWideImagesRule(getResources());                            break;

                    boolean antiAlias = manager.getAntiAlias();                        case FIT_HEIGHT:

                    boolean antiAliasScrolling = manager.getAntiAliasWhileScrolling();                            scale = scaleY;

                    imagePaint.setAntiAlias(antiAlias && (!isScrolling || antiAliasScrolling));                            break;

                        default:

                    float scaleX = (float) width / bitmap.getWidth();                            scale = Math.max(scaleX, scaleY);

                    float scaleY = (float) height / bitmap.getHeight();                    }

                    float scale = 1f;

                    int left = 0;                    int scaledWidth = Math.round(bitmap.getWidth() * scale);

                    int top = 0;                    int scaledHeight = Math.round(bitmap.getHeight() * scale);



                    switch(rule) {                    canvas.drawColor(Color.BLACK);

                        case FIT_WIDTH:

                            scale = scaleX;                    if (scaledWidth > width) {

                            break;                        float maxDeltaX = scaledWidth - width;

                        case FIT_HEIGHT:                        if (deltaX > maxDeltaX) {

                            scale = scaleY;                            deltaX = maxDeltaX;

                            break;                        }

                        default:                        left = -Math.round(deltaX);

                            scale = Math.max(scaleX, scaleY);                    } else {

                    }                        left = (width - scaledWidth) / 2;

                    }

                    int scaledWidth = Math.round(bitmap.getWidth() * scale);

                    int scaledHeight = Math.round(bitmap.getHeight() * scale);                    if (scaledHeight > height) {

                        top = 0;

                    canvas.drawColor(Color.BLACK);                    } else {

                        top = (height - scaledHeight) / 2;

                    if (scaledWidth > width) {                    }

                        float maxDeltaX = scaledWidth - width;

                        if (deltaX > maxDeltaX) {                    canvas.save();

                            deltaX = maxDeltaX;                    canvas.translate(left, top);

                        }                    canvas.scale(scale, scale);

                        left = -Math.round(deltaX);                    canvas.drawBitmap(bitmap, 0, 0, imagePaint);

                    } else {                    canvas.restore();

                        left = (width - scaledWidth) / 2;

                    }                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {

                        notifyColorsChanged();

                    if (scaledHeight > height) {                    }

                        top = 0;                }

                    } else {            } finally {

                        top = (height - scaledHeight) / 2;                if (canvas != null) {

                    }                    holder.unlockCanvasAndPost(canvas);

                }

                    canvas.save();            }

                    canvas.translate(left, top);        }

                    canvas.scale(scale, scale);

                    canvas.drawBitmap(bitmap, 0, 0, imagePaint);        private void drawBlackScreen() {

                    canvas.restore();            SurfaceHolder holder = getSurfaceHolder();

            Canvas canvas = null;

                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {            try {

                        notifyColorsChanged();                canvas = holder.lockCanvas();

                    }                if (canvas != null) {

                }                    canvas.drawColor(Color.BLACK);

            } finally {                }

                if (canvas != null) {            } finally {

                    holder.unlockCanvasAndPost(canvas);                if (canvas != null) {

                }                    holder.unlockCanvasAndPost(canvas);

            }                }

        }            }

        }

        private void drawBlackScreen() {

            SurfaceHolder holder = getSurfaceHolder();        @RequiresApi(api = Build.VERSION_CODES.O_MR1)

            Canvas canvas = null;        private void notifyColorsChanged() {

            try {            if (currentMediaHandler != null && currentMediaHandler.getCurrentMedia() != null) {

                canvas = holder.lockCanvas();                Bitmap bitmap = currentMediaHandler.getCurrentMedia().getImage();

                if (canvas != null) {                if (bitmap != null) {

                    canvas.drawColor(Color.BLACK);                    WallpaperColors colors = WallpaperColors.fromBitmap(bitmap);

                }                    notifyColorsChanged(colors);

            } finally {                }

                if (canvas != null) {            }

                    holder.unlockCanvasAndPost(canvas);        }

                }

            }        @Override

        }        public void onDestroy() {

            super.onDestroy();

        @RequiresApi(api = Build.VERSION_CODES.O_MR1)            if (currentMediaHandler != null) {

        private void notifyColorsChanged() {                currentMediaHandler.stop();

            if (currentMediaHandler != null && currentMediaHandler.getCurrentMedia() != null) {            }

                Bitmap bitmap = currentMediaHandler.getCurrentMedia().getImage();        }

                if (bitmap != null) {

                    WallpaperColors colors = WallpaperColors.fromBitmap(bitmap);        @Override

                    notifyColorsChanged(colors);        public void onOffsetsChanged(float xOffset, float yOffset, float xOffsetStep,

                }                                   float yOffsetStep, int xPixelOffset, int yPixelOffset) {

            }            if (currentMediaHandler != null && currentMediaHandler.getCurrentMedia() != null) {

        }                MediaInfo currentMedia = currentMediaHandler.getCurrentMedia();

                if (!currentMedia.isVideo()) {

        @Override                    deltaX = xOffset * (currentMedia.getImage().getWidth() - width);

        public void onDestroy() {                    displayCurrentMedia(currentMedia);

            super.onDestroy();                }

            if (currentMediaHandler != null) {            }

                currentMediaHandler.stop();        }

            }    }

        }}

                currentImageHandler.setDimensions(width, height, getApplicationContext());

        @Override                displayCurrentImage(currentImageHandler.getCurrentImage());

        public void onOffsetsChanged(float xOffset, float yOffset, float xOffsetStep,            }

                                   float yOffsetStep, int xPixelOffset, int yPixelOffset) {        }

            if (currentMediaHandler != null && currentMediaHandler.getCurrentMedia() != null) {

                MediaInfo currentMedia = currentMediaHandler.getCurrentMedia();        private void displayCurrentImage(ImageInfo imageInfo) {

                if (!currentMedia.isVideo()) {            handler.post(() -> {

                    deltaX = xOffset * (currentMedia.getImage().getWidth() - width);                if (!surfaceReady) return;

                    displayCurrentMedia(currentMedia);

                }                if (imageInfo != null && imageInfo.getUri() != null) {

            }                    if (isVideoUri(imageInfo.getUri())) {

        }                        playVideo(imageInfo.getUri());

    }                    } else {

}                        drawImage(imageInfo);
                    }
                } else {
                    drawBlackScreen();
                }
            });
        }

        private boolean isVideoUri(Uri uri) {
            String mimeType = getContentResolver().getType(uri);
            return mimeType != null && mimeType.startsWith("video/");
        }

        private void playVideo(Uri uri) {
            currentImageHandler.stop();
            // Release the current player immediately to stop video playback instantly.
            releaseMediaPlayer();

            // Post the creation and preparation of the new player to the handler with a small delay.
            // This ensures a clean separation and gives the system time to release the surface after canvas drawing, preventing race conditions.
            handler.postDelayed(() -> {
                // Check if the surface is still valid, as time has passed and the wallpaper might have been hidden.
                if (!surfaceReady) return;

                mediaPlayer = new MediaPlayer();
                try {
                    mediaPlayer.setDataSource(getApplicationContext(), uri);
                    mediaPlayer.setSurface(getSurfaceHolder().getSurface());
                    mediaPlayer.setLooping(true);

                    mediaPlayer.setOnPreparedListener(mp -> {
                        if (!surfaceReady) return; // Re-check surface validity before starting.
                        if (manager.getMuteVideos()) {
                            mp.setVolume(0f, 0f);
                        } else {
                            mp.setVolume(1f, 1f);
                        }
                        mp.start();
                    });

                    mediaPlayer.setOnCompletionListener(mp -> {
                        handler.post(() -> {
                            releaseMediaPlayer();
                            currentImageHandler.updateAfter(getApplicationContext(), 0);
                        });
                    });

                    mediaPlayer.setOnErrorListener((mp, what, extra) -> {
                        Log.e("VIDEO_PLAYBACK", "MediaPlayer error: what=" + what + ", extra=" + extra);
                        handler.post(() -> {
                            releaseMediaPlayer();
                            currentImageHandler.forceNextImage(getApplicationContext());
                        });
                        return true;
                    });
                    
                    mediaPlayer.prepareAsync();

                } catch (Exception e) {
                    Log.e("VIDEO_PLAYBACK", "Error setting up video playback", e);
                    handler.post(() -> {
                        releaseMediaPlayer();
                        currentImageHandler.forceNextImage(getApplicationContext());
                    });
                }
            }, 100); // 100ms delay
        }

        private void drawImage(ImageInfo image) {
            releaseMediaPlayer();
            if (currentImageHandler != null && !currentImageHandler.isStarted()) {
                currentImageHandler.startTimer(getApplicationContext());
            }

            SurfaceHolder holder = getSurfaceHolder();
            Canvas canvas = null;
            try {
                canvas = holder.lockCanvas();
                if (canvas != null) {
                    if (image != null && image.getImage() != null) {
                        Bitmap bitmap = image.getImage();
                        // ... (drawing logic remains the same)
                        SharedPreferencesManager.TooWideImagesRule rule = manager.getTooWideImagesRule(getResources());
                        boolean antiAlias = manager.getAntiAlias();
                        boolean antiAliasScrolling = manager.getAntiAliasWhileScrolling();
                        imagePaint.setAntiAlias(antiAlias && (!isScrolling || antiAliasScrolling));

                        if (rule == SharedPreferencesManager.TooWideImagesRule.SCALE_DOWN) {
                            canvas.drawBitmap(bitmap, ImageLoader.calculateMatrixScaleToFit(bitmap, width, height, true), imagePaint);
                        } else {
                            canvas.save();
                            canvas.translate(deltaX, 0);
                            canvas.drawBitmap(bitmap, ImageLoader.calculateMatrixScaleToFit(bitmap, width, height, false), imagePaint);
                            canvas.restore();
                        }
                    } else {
                        canvas.drawColor(Color.BLACK);
                    }
                }
            } finally {
                if (canvas != null) {
                    try {
                        holder.unlockCanvasAndPost(canvas);
                    } catch (Exception e) {
                        Log.e(SlideshowWallpaperService.class.getSimpleName(), "Error unlocking canvas", e);
                    }
                }
            }
        }
        
        private void drawBlackScreen() {
            SurfaceHolder holder = getSurfaceHolder();
            Canvas canvas = null;
            try {
                canvas = holder.lockCanvas();
                if (canvas != null) {
                    canvas.drawColor(Color.BLACK);
                }
            } finally {
                if (canvas != null) {
                    try {
                        holder.unlockCanvasAndPost(canvas);
                    } catch (Exception e) {
                        Log.e(SlideshowWallpaperService.class.getSimpleName(), "Error unlocking canvas", e);
                    }
                }
            }
        }

        @Override
        public void onSurfaceDestroyed(SurfaceHolder holder) {
            super.onSurfaceDestroyed(holder);
            surfaceReady = false;
            if (currentImageHandler != null) {
                currentImageHandler.stop();
            }
            releaseMediaPlayer();
        }

        private void releaseMediaPlayer() {
            if (mediaPlayer != null) {
                try {
                    if (mediaPlayer.isPlaying()) {
                        mediaPlayer.stop();
                    }
                    mediaPlayer.reset();
                    mediaPlayer.release();
                } catch (Exception e) {
                    Log.e("VIDEO_PLAYBACK", "Error during MediaPlayer release", e);
                } finally {
                    mediaPlayer = null;
                }
            }
        }

        @Override
        public void onVisibilityChanged(boolean visible) {
            super.onVisibilityChanged(visible);
            if (visible) {
                if (currentImageHandler != null) {
                    currentImageHandler.startTimer(getApplicationContext());
                }
            } else {
                if (currentImageHandler != null) {
                    currentImageHandler.stop();
                }
            }
        }

        @Override
        public void onOffsetsChanged(float xOffset, float yOffset, float xOffsetStep, float yOffsetStep, int xPixelOffset, int yPixelOffset) {
            super.onOffsetsChanged(xOffset, yOffset, xOffsetStep, yOffsetStep, xPixelOffset, yPixelOffset);
            if (currentImageHandler != null && currentImageHandler.getCurrentImage() != null && currentImageHandler.getCurrentImage().getImage() != null) {
                Bitmap image = currentImageHandler.getCurrentImage().getImage();
                deltaX = calculateDeltaX(image, xOffset, xOffsetStep);
                isScrolling = (Math.floor(xOffset) != xOffset);
                displayCurrentImage(currentImageHandler.getCurrentImage());
            }
        }

        private float calculateDeltaX(Bitmap image, float xOffset, float xOffsetStep) {
            int width = image.getWidth();
            float result = 0;
            SharedPreferencesManager.TooWideImagesRule rule = manager.getTooWideImagesRule(getResources());
            float scale = ImageLoader.calculateScaleFactorToFit(image, this.width, this.height, rule == SharedPreferencesManager.TooWideImagesRule.SCALE_DOWN);
            width = Math.round(width * scale);
            if (width > this.width) {
                if (rule == SharedPreferencesManager.TooWideImagesRule.SCALE_UP) {
                    xOffset = 0.5f;
                } else if (rule == SharedPreferencesManager.TooWideImagesRule.SCROLL_BACKWARD) {
                    xOffset = 1 - xOffset;
                }
                result = -xOffset * (width - this.width);
            }
            return result;
        }

        private SharedPreferences getSharedPreferences() {
            return SlideshowWallpaperService.this.getSharedPreferences(getPackageName() + "_preferences", MODE_PRIVATE);
        }
        
        @Override
        public void onTouchEvent(MotionEvent event) {
            gestureDetector.onTouchEvent(event);
        }
    }
}
        
